const fs = require('fs');


/**
 * The custom erros can refer to fields in the response object. The fields are defined by the object type and the field name.
 * The general rules for the field names are:
 *  - Normal Fields : <objecttype_name>.<field_name>
 *  - Nested Fields : <objecttype_name>.<nested_field_name>[<index>].<sub_field_name>
 *  - Reversed nested tables : <reverse_objecttype_name>.<reverse_field_name>[<index>].<field_name>
 *
 *  On nesteds if the "[]" is used without any number then we are referencing the nested field itself as a whole
 *
 * An example of a response with validation errors generated by this script is:
 *
 * {
 *     "code": "validation.plugin.error",
 *     "error": "Server Validation Error, see editor for details",
 *     "package": "",
 *     "parameters": {
 *         "problems": [
 *             [
 *                 {
 *                     "field": "myobjecttype.field_list[0].subfield_1",
 *                     "message": "message of the error",
 *                     "parameters": {
 *                         "a": "a",
 *                         "b": "b"
 *                     }
 *                 },
 *                 {
 *                     "field": "myobjecttype.field_list[]",
 *                     "message": "message of the error",
 *                     "parameters": {
 *                         "a": "a",
 *                         "b": "b"
 *                     }
 *                 },
 *                 {
 *                     "field": "myobjecttype.name",
 *                     "message": "message of the error",
 *                     "parameters": {
 *                         "a": "a",
 *                         "b": "b"
 *                     }
 *                 }
 *                 {
 *                     // Note that for reverse nested fields we use first the reverse objecttype name and then the reverse field name
 *                     "field": "otherObjectType.reverse_field[0].name",
 *                     "message": "message of the error",
 *                     "parameters": {
 *                         "a": "a",
 *                         "b": "b"
 *                     }
 *                 }
 *             ]
 *         ]
 *     },
 *     "realm": "api",
 *     "statuscode": 400
 * }
 */


let input = '';
process.stdin.on('data', d => {
    try {
        input += d.toString();
    } catch(e) {
        console.error(`Could not read input into string: ${e.message}`, e.stack);
        process.exit(1);
    }
});


process.stdin.on('end', () => {
    // Write input to a file for debugging purposes
    fs.writeFileSync('/tmp/validation_errors_input', input);
    console.log(JSON.stringify(
        {
            "code": "validation.plugin.error",
            "statuscode": 400,
            "parameters": {
                "problems": [
                    [
                        {
                            "message": "This is a validation error for no field",
                        },
                        {
                            "field": "validation_errors.name",
                            "message": "This is a dummy error for the name field",
                        },
                        {
                            "field": "validation_errors.no_existing_field",
                            "message": "This is a validation error for a field that does not exist",
                        }
                    ]
                ,
                    [
                        {
                            "message": "This is a validation error for no field",
                        },
                        {
                            "field": "validation_errors.name",
                            "message": "This is a dummy error for the name field",
                        },
                        {
                            "field": "validation_errors.no_existing_field",
                            "message": "This is a validation error for a field that does not exist",
                        }
                    ]
                ]
            }
        }
    ));
    console.error("This error goes to STDERR")
    process.exit(400);
});
